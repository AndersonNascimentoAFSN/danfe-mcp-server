# ============================================
# Dockerfile Otimizado para Render
# DANFE Downloader MCP Server
# ============================================

FROM --platform=linux/amd64 node:20-bullseye

# Metadados
LABEL maintainer="Anderson Nascimento"
LABEL description="MCP DANFE Downloader Server para Render"
LABEL version="2.0.0"

# ============================================
# Instalar depend√™ncias do sistema
# ============================================

RUN apt-get update && apt-get install -y \
    # xvfb - X Virtual Framebuffer (display virtual)
    xvfb \
    # Playwright/Chromium dependencies
    libnss3 \
    libnspr4 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libdrm2 \
    libdbus-1-3 \
    libxkbcommon0 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxrandr2 \
    libgbm1 \
    libasound2 \
    libpango-1.0-0 \
    libpangocairo-1.0-0 \
    libgtk-3-0 \
    # Fontes
    fonts-liberation \
    fonts-noto-color-emoji \
    # Utilit√°rios
    ca-certificates \
    wget \
    libappindicator3-1 \
    libnss3-dev \
    libxss1 \
    && rm -rf /var/lib/apt/lists/*

# ============================================
# Criar diret√≥rio da aplica√ß√£o
# ============================================

WORKDIR /app

# ============================================
# Instalar depend√™ncias Node.js
# ============================================

# Copiar apenas package files primeiro (melhor cache)
COPY package*.json ./

# Instalar TODAS as depend√™ncias (incluindo devDependencies para build)
RUN npm ci

# Instalar Playwright Chromium (ANTES de criar usu√°rio n√£o-root)
RUN npx playwright install chromium --with-deps

# Debugar onde o Playwright instalou os browsers
RUN echo "üîç Procurando instala√ß√£o do Playwright..." && \
    find / -name "*chromium*" -type d 2>/dev/null | head -10 && \
    find / -name "chrome" -type f 2>/dev/null | head -5 && \
    ls -la ~/.cache/ms-playwright/ 2>/dev/null || echo "N√£o encontrado em ~/.cache/ms-playwright" && \
    echo "‚úÖ Playwright instalado - debugging conclu√≠do"

# ============================================
# Configura√ß√£o de usu√°rio (seguran√ßa)
# ============================================

# Criar usu√°rio n√£o-root para executar a aplica√ß√£o
RUN groupadd -r nodejs && useradd -r -g nodejs nodejs

# ============================================
# Copiar c√≥digo fonte e build
# ============================================

COPY . .

# Dar permiss√£o de execu√ß√£o ao script start
RUN chmod +x start.sh

# Compilar TypeScript  
RUN npm run build

# Remover devDependencies ap√≥s build para reduzir tamanho da imagem
RUN npm prune --production

# Criar diret√≥rio de downloads
RUN mkdir -p downloads

# Ajustar permiss√µes
RUN chown -R nodejs:nodejs /app && \
    chown -R nodejs:nodejs ~/.cache/ms-playwright/ 2>/dev/null || echo "Playwright cache n√£o encontrado para chown"

# Mudar para usu√°rio n√£o-root
USER nodejs

# ============================================
# Configurar vari√°veis de ambiente
# ============================================

# Display virtual do xvfb
ENV DISPLAY=:99

# Diret√≥rio dos browsers do Playwright (usar caminho padr√£o)
# ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright (removido - deixar Playwright usar padr√£o)

# Node.js em modo produ√ß√£o
ENV NODE_ENV=production

# ============================================
# Expor porta
# ============================================

# Render define PORT dinamicamente, mas vamos expor as portas mais comuns
EXPOSE 3000 10000 8080

# ============================================
# Health Check
# ============================================

# Health check otimizado para Render (port detection)
HEALTHCHECK --interval=30s --timeout=5s --start-period=60s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:${PORT:-10000}/health || exit 1

# ============================================
# Comando de inicializa√ß√£o
# ============================================

CMD ["/app/start.sh"]